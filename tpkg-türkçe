#!/bin/bash

# Package Manager Script - A simple script to fetch and compile packages from a specified repository URL

# Set the repository URL where packages are hosted
url="yourwebsite.com/packages/"  # Kendi web sitenizin URL'si ile değiştirin
root="/home/richard/root"        # Kök dizinin mutlak yolu

# Geçerli dizini belirtilen kök dizinine değiştir
cd "$root"

# Dizin değişikliğinin başarılı olup olmadığını kontrol et
if [ "$(pwd)" != "$root" ]; then
    echo "Kök önekine dizin değiştirilemedi."
    exit 1
fi

# Fonksiyon: Paket yükleme
install_package() {
    local package_name="$1"
    
    # Paket adının belirtilip belirtilmediğini kontrol et
    if [ -z "$package_name" ]; then
        echo "Lütfen yüklenecek bir paket belirtin."
        exit 1
    elif [ -d "usr/tdb/$package_name" ]; then
        echo "$package_name zaten yüklü."
        exit 1
    fi

    # Paket URL'si oluştur
    package_url="$url$package_name/"
    
    # Deposunda paketin olup olmadığını kontrol et
    package_check=$(curl -Is "$package_url" | head -n 1)
    
    if [[ $package_check == *"200"* ]]; then
        echo "$package_name paketi bulundu. Yüklemeye devam ediliyor."
    else
        echo "$package_name doğru yazıldığından emin misiniz?"
        read -p "Devam etmek istiyor musunuz? [e/h]: " answer
        
        if [ "$answer" != "e" ]; then
            exit 1
        fi
    fi

    # Paketi URL'den indir
    echo "Paket indiriliyor..."
    busybox wget -cq "$package_url$package_name.tar"  # Paketi URL'den al

    # İndirme başarılı mı diye kontrol et
    if [ "$?" = "0" ]; then
        echo "İndirme başarılı. Paket derleniyor..."
        tar -xf "$package_name.tar"
        rm "$package_name.tar"
        echo "Yükleme başarılı."

        # Loglama: Yüklenen paketler için bir log dosyası oluştur
        if [ ! -d "/home/$(whoami)/.tpkg/" ]; then
            mkdir -p "/home/$(whoami)/.tpkg/"
        fi

        if [ ! -f "/home/$(whoami)/.tpkg/installed.txt" ]; then
            touch "/home/$(whoami)/.tpkg/installed.txt"
        fi

        if [ ! -f "/home/$(whoami)/.tpkg/removed.txt" ]; then
            touch "/home/$(whoami)/.tpkg/removed.txt"
        fi

        echo "$package_name $(date)'da yüklendi" >> "/home/$(whoami)/.tpkg/installed.txt"
    else
        echo "Yükleme başarısız."
        exit 1
    fi
}

# Fonksiyon: Paket Kaldırma
remove_package() {
    local package_name="$1"
    
    # Paket adının belirtilip belirtilmediğini kontrol et
    if [ -z "$package_name" ]; then
        echo "Lütfen kaldırılacak bir paket belirtin."
        exit 1
    elif [ ! -d "usr/tdb/$package_name" ]; then
        echo "$package_name yüklü değil."
        exit 1
    fi
    
    # Paketi kaldırma işlemi
    # ...

    echo "$package_name başarıyla kaldırıldı."
}

# Fonksiyon: Paket Güncelleme
update_package() {
    local package_name="$1"
    
    # Paket adının belirtilip belirtilmediğini kontrol et
    if [ -z "$package_name" ]; then
        echo "Lütfen güncellenecek bir paket belirtin."
        exit 1
    elif [ ! -d "usr/tdb/$package_name" ]; then
        echo "$package_name yüklü değil."
        exit 1
    fi
    
    # Paketi güncelleme işlemi
    # ...

    echo "$package_name başarıyla güncellendi."
}

# Fonksiyon: Tüm Paketleri Listeleme
list_packages() {
    echo "Yüklü paketler:"
    ls -1 usr/tdb/
}

# Bağımlılıkları kontrol etme fonksiyonu
check_dependencies() {
    # 'curl', 'busybox' ve 'tar' komutlarının var olup olmadığını kontrol et
    if ! command -v curl &> /dev/null || ! command -v busybox &> /dev/null || ! command -v tar &> /dev/null; then
        echo "Bu betik 'curl', 'busybox' ve 'tar'ın düzgün çalışması için gereklidir."
        echo "Lütfen betiği çalıştırmadan önce bu bağımlılıkları yükleyin."
        exit 1
    fi
}

# Ana betik
if [ "$1" = "install" ]; then
    check_dependencies  # Yüklemeden önce bağımlılıkları kontrol et
    install_package "$2"
elif [ "$1" = "remove" ]; then
    remove_package "$2"
elif [ "$1" = "update" ]; then
    update_package "$2"
elif [ "$1" = "list" ]; then
    list_packages
else
    echo "Hiçbir eylem belirtilmedi."
    exit 1
fi
